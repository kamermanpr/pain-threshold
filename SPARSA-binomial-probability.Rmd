---
title: 'Binomial probability'
author: "Peter Kamerman and Tory Madden"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: 
  html_document:
    keep_md: true
    theme: yeti
    hightlight: pygments
    toc: true
    toc_depth: 5
    toc_float: true
    code_folding: show
---

```{r setup, include = FALSE}
# Load packages
library(tidyverse)
library(magrittr)

# Set ggplot theme
theme_set(new = theme_bw(base_size = 14))

# knitr setup
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      fig.retina = 2,
                      fig.align = 'center',
                      fig.path = './figures/binomial-analysis/')
```

----

## Question
For each stimulus intenisty, what is the probability that the set of 12 repeated stimuli include zero?

To assess the probability, we modelled the data using the binomial test with a 50% probability of _'success'_ (positive rating arbitrarily chosen as success) at each stimulus intensity for each participant. Significance was assessed at the $\alpha$ = 0.05 level, using a two-tailed probability. 

----

# SPARS A

## Import and inspect SPARS A data

```{r sparsA_import}
# Import
data <- read_rds('data/SPARS_A.rds')

# Inspect
glimpse(data)
```

## Process SPARS A data

```{r sparsA_process}
# Select columns
data %<>%
    select(PID, intensity, rating)

# Nest data by PID and stimulus intensity
data_nest <- data %>% 
    group_by(PID, intensity) %>% 
    nest()

# Check number of repeats at each stimulus intensity
data %>% 
    group_by(PID, intensity) %>% 
    summarise(repeats = n())

# Generate data
data_nest %<>% 
    # Add probability of success column
    mutate(prob = 0.5) %>% 
    # Extract rating data from dataframe
    mutate(data_vec = map(.x = data,
                          ~ .$rating)) %>% 
    # Recode rating data as categories according to sign
    mutate(data_cat = map(.x = data_vec,
                          ~ ifelse(.x < 0,
                                   yes = 'negative',
                                   no = ifelse(.x > 0,
                                               yes = 'positive',
                                               no = 'zero')))) %>% 
    # Count the number of positive and negative ratings
    ## positive numbers arbitrarily listed first == 'success'
    mutate(success_count = map(.x = data_cat,
                           ~ c(length(.x[.x == 'positive']), 
                               length(.x[.x == 'negative'])))) %>% 
    # Conduct binomial test (two-sided)
    mutate(binomial_test = map2(.x = success_count,
                                .y = prob,
                                ~ binom.test(x = .x, 
                                             p = .y))) %>% 
    # Extract p-value from binomial_test
    mutate(binomial_p.value = map(.x = binomial_test,
                                 ~ .x$p.value %>% 
                                     round(., 3))) %>% 
    # Categorise p-value using a p < 0.05 threshold
    ## No correction for multiple comparisons 
    ## (too conservative for explorartory analysis)
    mutate(binomial_p.interpretation = map(.x = binomial_p.value,
                                           ~ ifelse(.x < 0.05,
                                                    yes = 'significant',
                                                    no = 'not significant')))
```

## Plot SPARS A data

```{r sparsA_plot, fig.height = 10, fig.width = 9}
data_nest %>% 
    # Select data columns
    select(PID, intensity, binomial_p.interpretation) %>% 
    # Unnest data
    unnest() %>% 
    # Recode binomial_p.interpretation
    mutate(binomial_p.interpretation = 
               ifelse(binomial_p.interpretation == 'significant',
                      yes = 'Yes',
                      no = 'No')) %>% 
    # Join with original data
    right_join(data) %>% 
    # Reclass intensity as an ordered factor
    mutate(intensity = factor(intensity, 
                              ordered = TRUE)) %>% 
    # Plot
    ggplot(data = .) +
    aes(x = intensity,
        y = rating) +
    geom_hline(yintercept = 0) +
    geom_point(aes(fill = binomial_p.interpretation),
               colour = '#000000',
               shape = 21,
               size = 3,
               alpha = 0.7) + 
    labs(title = "SPARS A: Binomial test of positive/negative rating distribution",
         subtitle = "(probability of 'success' = 0.5 | alpha = 0.05 | two-tailed p-value)",
         x = 'Stimulus intensity (J)',
         y = 'SPARS rating') +
    scale_x_discrete(breaks = seq(1, 4, by = 0.5),
                     labels = sprintf('%.2f', seq(1, 4, by = 0.5))) +
    scale_y_continuous(limits = c(-50, 50)) +
    scale_fill_viridis_d(name = 'Deviates significantly: ',
                         option = 'C') +
    scale_colour_viridis_d(name = 'Deviates from expected: ',
                           option = 'C') +
    facet_wrap(~ PID, 
               ncol = 4) +
    theme(legend.position = 'top',
          panel.grid = element_blank(),
          axis.text.x = element_text(angle = -90, 
                                     hjust = 0, 
                                     vjust = 0.5))
```

----

# SPARS B

## Import and inspect SPARS B data

```{r sparsB_import}
# Import
data <- read_rds('data/SPARS_B.rds')

# Inspect
glimpse(data)
```

## Process SPARS B data

```{r sparsB_process}
# Select columns
data %<>%
    filter(scale == 'SPARS') %>% 
    filter(rating != 0) %>% 
    select(PID, intensity, rating) 

# Check number of repeats at each stimulus intensity
data %>% 
    group_by(PID, intensity) %>% 
    summarise(repeats = n())

# Nest data by PID and stimulus intensity
data_nest <- data %>% 
    group_by(PID, intensity) %>% 
    nest()

# Generate data
data_nest %<>% 
    # Add probability of success column
    mutate(prob = 0.5) %>% 
    # Extract rating data from dataframe
    mutate(data_vec = map(.x = data,
                          ~ .$rating)) %>% 
    # Recode rating data as categories according to sign
    mutate(data_cat = map(.x = data_vec,
                          ~ ifelse(.x < 0,
                                   yes = 'negative',
                                   no = 'positive'))) %>% 
    # Count the number of positive and negative ratings
    ## positive numbers arbitrarily listed first == 'success'
    mutate(success_count = map(.x = data_cat,
                           ~ c(length(.x[.x == 'positive']), 
                               length(.x[.x == 'negative'])))) %>% 
    # Conduct binomial test (two-sided)
    mutate(binomial_test = map2(.x = success_count,
                                .y = prob,
                                ~ binom.test(x = .x, 
                                             p = .y))) %>% 
    # Extract p-value from binomial_test
    mutate(binomial_p.value = map(.x = binomial_test,
                                 ~ .x$p.value %>% 
                                     round(., 3))) %>% 
    # Categorise p-value using a p < 0.05 threshold
    ## No correction for multiple comparisons 
    ## (too conservative for explorartory analysis)
    mutate(binomial_p.interpretation = map(.x = binomial_p.value,
                                           ~ ifelse(.x < 0.05,
                                                    yes = 'significant',
                                                    no = 'not significant')))
```

## Plot SPARS B data

```{r sparsB_plot, fig.height = 5.6, fig.width = 9}
data_nest %>% 
    # Select data columns
    select(PID, intensity, binomial_p.interpretation) %>% 
    # Unnest data
    unnest() %>% 
    # Recode binomial_p.interpretation
    mutate(binomial_p.interpretation = 
               ifelse(binomial_p.interpretation == 'significant',
                      yes = 'Yes',
                      no = 'No')) %>% 
    # Join with original data
    right_join(data) %>% 
    # Reclass intensity as an ordered factor
    mutate(intensity = factor(intensity, 
                              ordered = TRUE)) %>% 
    # Plot
    ggplot(data = .) +
    aes(x = intensity,
        y = rating) +
    geom_hline(yintercept = 0) +
    geom_point(aes(fill = binomial_p.interpretation),
               colour = '#000000',
               shape = 21,
               size = 3,
               alpha = 0.7) + 
    labs(title = "SPARS B: Binomial test of positive/negative rating distribution",
         subtitle = "(probability of 'success' = 0.5 | alpha = 0.05 | two-tailed p-value)",
         x = 'Stimulus intensity (J)',
         y = 'SPARS rating') +
    scale_x_discrete(breaks = seq(1, 4.5, by = 0.25),
                     labels = sprintf('%.2f', seq(1, 4.5, by = 0.25))) +
    scale_y_continuous(limits = c(-50, 50)) +
    scale_fill_viridis_d(name = 'Deviates significantly: ',
                         option = 'C') +
    scale_colour_viridis_d(name = 'Deviates from expected: ',
                           option = 'C') +
    facet_wrap(~ PID, 
               ncol = 4,
               scales = 'free_x') +
    theme(legend.position = 'top',
          panel.grid = element_blank(),
          axis.text.x = element_text(angle = -90, 
                                     hjust = 0, 
                                     vjust = 0.5))
```
----

## Session information

```{r session_info}
sessionInfo()
```
