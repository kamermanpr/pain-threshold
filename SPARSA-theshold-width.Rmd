---
title: "SPARS_A: Width of pain threshold"
author: "Tory Madden and Peter Kamerman"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: 
  html_document:
    theme: yeti
    hightlight: pygments
    toc: true
    toc_depth: 5
    toc_float: true
    code_folding: show
---

```{r setup, include = FALSE}
# Load packages
library(tidyverse)
library(magrittr)
library(boot)

# Set ggplot theme
theme_set(new = theme_bw())

# knitr setup
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE,
                      fig.height = 8,
                      fig.width = 8,
                      fig.align = 'center',
                      fig.path = './figures/SPARSA_plots/',
                      cache = TRUE)
```

----

# Question
How wide is the pain threshold on the SPARS_A data?

Here, we calculated the median and bootstrapped CI for each individual, at each intensity rank. Next, we plotted those statistics to show how many of each individual's CIs crossed zero. We also repeated the process with group-level data, not grouping by individual.

----

# Import and inspect data

```{r import}
# Import
data <- read_rds('cleaned-data/SPARS_A.rds')

# Inspect
glimpse(data)
```

----

# Bootstrapping procedure

```{r bootstrap_indiv}
# Nest in preparation for bootstrapping
data_boot <- data %>%
  group_by(PID, intensity) %>%
  nest()

# Define bootstrap function
boot_median <- function(d,i){
  median(d[i], na.rm = TRUE)
}

# Perform bootstrap
data_boot %<>% 
    mutate(boot = map(.x = data, 
                      ~ boot(data = .x$rating, 
                             statistic = boot_median, 
                             R = 1999,
                             stype = 'i')))

# Remove NULL bootstrap row 56 (ID05)
data_boot <- data_boot[-56, ]

data_boot %<>% 
    mutate(boot_ci = map(.x = boot,
                         ~ boot.ci(.x,
                                   type = 'basic')))

# Extract the data, giving original median and bootstrapped CI
data_boot %<>% 
    mutate(median = map_dbl(.x = boot_ci,
                            ~ .x$t0),
           lower_ci = map_dbl(.x = boot_ci,
                              ~ .x$basic[[4]]),
           upper_ci = map_dbl(.x = boot_ci,
                              ~ .x$basic[[5]]))

# Delete unwanted columns 
data_boot %<>% 
    select(-data, -boot, -boot_ci)

# Clean impossible ratings
data_boot %<>%
    mutate(upper_ci = ifelse(upper_ci > 50,
                             yes = 50,
                             no = upper_ci),
         lower_ci = ifelse(lower_ci < -50,
                           yes = -50,
                           no = lower_ci)) 
```

# Plots at individual level

```{r plots_indiv}
# Plot individual CIs at every intensity
ggplot(data = data_boot) +
  aes(x = as.factor(intensity)) +
  geom_crossbar(aes(y = median,
                    ymin = lower_ci,
                    ymax = upper_ci)) +
  geom_hline(yintercept = 0) +
  facet_wrap(~ PID, nrow = 3) +
  labs(title = "Bootstrapped 95% CI for each participant's median SPARS rating at each intensity")
```

```{r bootstrap_group}
# Nest in preparation for bootstrapping
df_boot_group_SPARS <- df %>%
  group_by(intensity) %>%
  nest()

# Bootstrap function

boot_median_SPARS <- function(d,i){
  median(d[i])
}

# Make bootstrap

df_boot_group_SPARS %<>% mutate(boot = map(.x = data, 
                               ~ boot(data = .x$rating, 
                                      statistic = boot_median_SPARS, 
                                      R = 10000,
                                      stype = 'i')))

df_boot_group_SPARS %<>% mutate(boot_ci = map(.x = boot,
                                  ~ boot.ci(.x,
                                            type = 'basic')))

# Extract the data, giving original median and bootstrapped CI

df_boot_group_SPARS %<>% mutate(median = map(.x = boot_ci,
                                 ~ .x$t0),
                    lower_ci = map(.x = boot_ci,
                                   ~ .x$basic[[4]]),
                    upper_ci = map(.x = boot_ci,
                                   ~ .x$basic[[5]]))

# Delete unwanted columns

df_boot_group_SPARS %<>% select (-data, -boot, -boot_ci) %>%
  unnest()
```

# Plots at group level

```{r plots_group}

# Plot group CIs at every intensity

ggplot(data = df_boot_group_SPARS) +
  aes(x = as.factor(intensity)) +
  geom_crossbar(aes(y = median,
                    ymin = lower_ci,
                    ymax = upper_ci)) +
  geom_hline(yintercept = 0) +
  labs(title = "Bootstrapped 95% CI for group median SPARS ratings at each intensity rank")
```

# Conclusion

On the SPARS scale, with these data, between 2 and 9 of 13 different intensities of laser stimulation lay over the pain threshold for 19 participants, as indicated by the bootstrapped 95% confidence interval for the median SPARS rating crossing zero.  At the group level, 4 of 13 intensities of laser stimulation lay over the pain threshold.

## Session information
```{r session_info}
sessionInfo()
```
